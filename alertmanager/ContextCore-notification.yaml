# ContextCore Alertmanager Notification Configuration
# Enhanced with Capability Index (x-capability-index) for discoverability and operational clarity.
#
# Target Alertmanager version: v0.27.x
# The x-capability-index block is a custom extension ignored by Alertmanager at runtime.
# See design document for compatibility details and rollback procedures.
#
# Validation: Run `amtool check-config alertmanager/ContextCore-notification.yaml` before deploying.

# --- Capability Index (custom extension, ignored by Alertmanager) ---
x-capability-index:
  version: "1.1.0"
  schema: "ContextCore-notification/v1"
  last_modified: "2025-01-15T10:00:00Z"
  capabilities:
    - id: "cap-email-critical"
      type: "notification"
      channel: "email"
      severity_filter:
        - "critical"
      receiver_ref: "email-critical-team"
      description: "Routes critical alerts to the on-call engineering email distribution list."
    - id: "cap-slack-warning"
      type: "notification"
      channel: "slack"
      severity_filter:
        - "warning"
        - "info"
      receiver_ref: "slack-ops-channel"
      description: "Sends warning and info alerts to the #ops-alerts Slack channel."
    - id: "cap-pagerduty-oncall"
      type: "escalation"
      channel: "pagerduty"
      severity_filter:
        - "critical"
      receiver_ref: "pagerduty-oncall"
      description: "Escalates critical alerts to the PagerDuty on-call rotation."
  tags:
    owner: "platform-team"
    environment: "production"

# --- Global configuration ---
global:
  resolve_timeout: "5m"
  smtp_smarthost: "smtp.example.com:587"
  smtp_from: "alertmanager@example.com"
  smtp_auth_username: "alertmanager@example.com"
  smtp_auth_password: "placeholder-password"
  smtp_require_tls: true
  slack_api_url: "https://hooks.slack.com/services/PLACEHOLDER/PLACEHOLDER/PLACEHOLDER"
  pagerduty_url: "https://events.pagerduty.com/v2/enqueue"

# --- Notification templates ---
templates:
  - "/etc/alertmanager/templates/*.tmpl"

# --- Routing tree ---
route:
  receiver: "slack-ops-channel"
  group_by:
    - "alertname"
    - "cluster"
    - "service"
  group_wait: "30s"
  group_interval: "5m"
  repeat_interval: "4h"
  routes:
    - receiver: "email-critical-team"
      matchers:
        - severity="critical"
      continue: true
    - receiver: "pagerduty-oncall"
      matchers:
        - severity="critical"
      group_wait: "10s"
      repeat_interval: "1h"
    - receiver: "slack-ops-channel"
      matchers:
        - severity=~"warning|info"

# --- Receivers ---
receivers:
  - name: "email-critical-team"
    email_configs:
      - to: "oncall-engineering@example.com"
        send_resolved: true
        headers:
          Subject: "[CRITICAL] {{ .GroupLabels.alertname }} - {{ .GroupLabels.cluster }}"

  - name: "slack-ops-channel"
    slack_configs:
      - channel: "#ops-alerts"
        send_resolved: true
        title: "{{ .GroupLabels.alertname }}"
        text: "{{ range .Alerts }}{{ .Annotations.summary }}\n{{ end }}"

  - name: "pagerduty-oncall"
    pagerduty_configs:
      - service_key: "placeholder-pagerduty-service-key"
        send_resolved: true
        description: "{{ .GroupLabels.alertname }}: {{ .CommonAnnotations.summary }}"
        severity: "{{ .GroupLabels.severity }}"

# --- Inhibition rules ---
inhibit_rules:
  - source_matchers:
      - severity="critical"
    target_matchers:
      - severity="warning"
    equal:
      - "alertname"
      - "cluster"
      - "service"

  - source_matchers:
      - alertname="InfoInhibitor"
    target_matchers:
      - severity="info"
    equal:
      - "namespace"