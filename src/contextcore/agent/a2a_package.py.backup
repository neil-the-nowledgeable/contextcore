# src/contextcore/a2a/__init__.py
"""
A2A Protocol Adapter for ContextCore

This package provides bidirectional compatibility with the A2A Protocol,
enabling ContextCore agents to communicate with A2A-compatible agents.

Components:
- TaskAdapter: Convert between A2A Task and CC Handoff
- A2AMessageHandler: Handle JSON-RPC 2.0 requests
- A2AServer: HTTP server for A2A endpoints
- A2AClient: Client for remote A2A agents

Example Server:
    from contextcore.a2a import create_a2a_server

    server = create_a2a_server(
        agent_id="my-agent",
        agent_name="My Agent",
        base_url="http://localhost:8080",
        project_id="my-project",
    )
    server.run()

Example Client:
    from contextcore.a2a import A2AClient
    from contextcore.models import Message

    with A2AClient("http://remote-agent:8080") as client:
        result = client.send_text("Hello, remote agent!")
        print(result)
"""

from .task_adapter import TaskAdapter, TaskState
from .message_handler import A2AMessageHandler, A2AErrorCode
from .server import A2AServer, create_a2a_server
from .client import A2AClient, A2AError

__all__ = [
    "TaskAdapter",
    "TaskState",
    "A2AMessageHandler",
    "A2AErrorCode",
    "A2AServer",
    "create_a2a_server",
    "A2AClient",
    "A2AError",
]


# src/contextcore/cli/a2a.py
"""
A2A CLI Commands

Provides command-line interface for A2A protocol operations including
server management, message sending, task status checking, and agent
card retrieval.
"""

import json
import sys
from typing import Dict, Any

import click

from contextcore.a2a import create_a2a_server, A2AClient, A2AError


@click.group("a2a")
def a2a_group() -> None:
    """A2A protocol commands."""
    pass


@click.command("serve")
@click.option("--agent-id", required=True, help="Agent identifier")
@click.option("--name", required=True, help="Agent display name")
@click.option("--project-id", required=True, help="Project identifier")
@click.option("--host", default="0.0.0.0", help="Server host")
@click.option("--port", default=8080, type=int, help="Server port")
@click.option("--framework", type=click.Choice(["flask", "fastapi"]), default="flask", help="Server framework")
def serve_command(agent_id: str, name: str, project_id: str, host: str, port: int, framework: str) -> None:
    """Start A2A protocol server."""
    try:
        base_url = f"http://{host}:{port}"
        click.echo(f"Starting A2A server for agent '{name}' ({agent_id}) on {base_url}")
        
        # Create and configure server
        server = create_a2a_server(
            agent_id=agent_id,
            agent_name=name,
            base_url=base_url,
            project_id=project_id,
        )
        
        click.echo(f"Server ready - framework: {framework}")
        server.run(host=host, port=port)
        
    except OSError as e:
        click.echo(f"Error: Failed to start server - {e}", err=True)
        sys.exit(1)
    except KeyboardInterrupt:
        click.echo("\nServer stopped by user", err=True)
        sys.exit(0)
    except Exception as e:
        click.echo(f"Error: Unexpected server error - {e}", err=True)
        sys.exit(1)


@click.command("send")
@click.option("--url", required=True, help="Remote agent URL")
@click.option("--message", "-m", required=True, help="Message text")
@click.option("--wait/--no-wait", default=True, help="Wait for completion")
@click.option("--timeout", default=300000, type=int, help="Timeout in milliseconds")
def send_command(url: str, message: str, wait: bool, timeout: int) -> None:
    """Send message to remote A2A agent."""
    # Validate input
    if not message.strip():
        click.echo("Error: Message cannot be empty", err=True)
        sys.exit(1)
    
    try:
        # Convert timeout from milliseconds to seconds for client
        timeout_seconds = timeout / 1000.0
        
        with A2AClient(url, timeout=timeout_seconds) as client:
            click.echo(f"Sending message to {url}...")
            
            if wait:
                result = client.send_text(message)
                click.echo("Response received:")
                _print_json(result)
            else:
                # Send without waiting for completion
                task_id = client.send_text(message, wait=False)
                click.echo(f"Message sent successfully. Task ID: {task_id}")
                
    except A2AError as e:
        click.echo(f"A2A Error: {e}", err=True)
        sys.exit(1)
    except ConnectionError as e:
        click.echo(f"Connection Error: Unable to reach {url} - {e}", err=True)
        sys.exit(1)
    except Exception as e:
        click.echo(f"Error: Unexpected error - {e}", err=True)
        sys.exit(1)


@click.command("status")
@click.option("--url", required=True, help="Remote agent URL")
@click.option("--task-id", required=True, help="Task ID to check")
def status_command(url: str, task_id: str) -> None:
    """Get status of remote task."""
    try:
        with A2AClient(url) as client:
            click.echo(f"Checking status of task {task_id} at {url}...")
            status = client.get_task_status(task_id)
            
            click.echo("Task Status:")
            _print_json(status)
            
    except A2AError as e:
        click.echo(f"A2A Error: {e}", err=True)
        sys.exit(1)
    except ConnectionError as e:
        click.echo(f"Connection Error: Unable to reach {url} - {e}", err=True)
        sys.exit(1)
    except Exception as e:
        click.echo(f"Error: Unexpected error - {e}", err=True)
        sys.exit(1)


@click.command("card")
@click.option("--url", required=True, help="Remote agent URL")
def card_command(url: str) -> None:
    """Fetch AgentCard from remote agent."""
    try:
        with A2AClient(url) as client:
            click.echo(f"Fetching agent card from {url}...")
            card = client.get_agent_card()
            
            click.echo("Agent Card:")
            _print_json(card)
            
    except A2AError as e:
        click.echo(f"A2A Error: {e}", err=True)
        sys.exit(1)
    except ConnectionError as e:
        click.echo(f"Connection Error: Unable to reach {url} - {e}", err=True)
        sys.exit(1)
    except Exception as e:
        click.echo(f"Error: Unexpected error - {e}", err=True)
        sys.exit(1)


def _print_json(data: Dict[str, Any]) -> None:
    """Helper function to pretty-print JSON data."""
    try:
        formatted = json.dumps(data, indent=2, ensure_ascii=False)
        click.echo(formatted)
    except (TypeError, ValueError):
        # Fallback if data is not JSON serializable
        click.echo(str(data))


# Register commands with the group
a2a_group.add_command(serve_command)
a2a_group.add_command(send_command)
a2a_group.add_command(status_command)
a2a_group.add_command(card_command)

__all__ = [
    "a2a_group",
    "serve_command",
    "send_command", 
    "status_command",
    "card_command",
]
