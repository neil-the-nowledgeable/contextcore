# src/contextcore/discovery/__init__.py

"""Agent Discovery Package

This package provides agent discovery capabilities for the ContextCore project,
including agent card management, discovery endpoints, and client operations.

Public classes:
- AgentCard: Agent metadata and capabilities
- AgentCapabilities: Skill and authentication definitions  
- SkillDescriptor: Individual skill definition
- AuthConfig: Authentication configuration
- AuthScheme: Authentication scheme enumeration
- ProviderInfo: Provider metadata
- DiscoveryEndpoint: Well-known endpoint structures
- DiscoveryDocument: Structure for discovery documents
- DiscoveryClient: Client for fetching remote agent data

Usage:
    from contextcore.discovery import AgentCard, DiscoveryClient
    
    # Create agent card
    card = AgentCard(
        agent_id="my-agent", 
        name="My Agent", 
        url="http://localhost:8080"
    )
    
    # Fetch remote agent
    client = DiscoveryClient()
    remote_card = client.fetch_agent_card("http://remote-agent.com")
    
    # Generate agent card JSON
    card_json = card.to_dict()
"""

from .models import (
    AgentCard,
    AgentCapabilities, 
    SkillDescriptor,
    AuthConfig,
    AuthScheme,
    ProviderInfo
)
from .endpoints import DiscoveryEndpoint, DiscoveryDocument
from .client import DiscoveryClient

__all__ = [
    "AgentCard",
    "AgentCapabilities", 
    "SkillDescriptor",
    "AuthConfig",
    "AuthScheme",
    "ProviderInfo",
    "DiscoveryEndpoint",
    "DiscoveryDocument", 
    "DiscoveryClient"
]

__version__ = "1.0.0"


# src/contextcore/cli/discovery.py

"""CLI commands for agent discovery operations."""

import json
import os
from pathlib import Path
from typing import Optional

import click

from contextcore.discovery import AgentCard, DiscoveryClient


@click.group("discovery")
def discovery_group():
    """Agent discovery commands for managing and interacting with agents."""
    pass


@click.command("card")
@click.option("--agent-id", required=True, help="Agent identifier")
@click.option("--name", required=True, help="Agent display name")
@click.option("--url", required=True, help="Agent base URL")
@click.option("--description", default="", help="Agent description")
@click.option("--output", "-o", type=click.Path(), help="Output file path")
@click.option("--format", type=click.Choice(["a2a", "contextcore"]), default="contextcore", help="Output format")
def card_command(
    agent_id: str, 
    name: str, 
    url: str, 
    description: str, 
    output: Optional[str], 
    format: str
) -> None:
    """Generate an AgentCard JSON file."""
    try:
        # Create the agent card
        card = AgentCard(
            agent_id=agent_id,
            name=name, 
            url=url,
            description=description
        )
        
        # Convert to appropriate format
        if format == "contextcore":
            card_data = card.to_dict()
        else:  # a2a format
            card_data = card.to_a2a_format()
        
        # Output to file or stdout
        if output:
            output_path = Path(output)
            output_path.parent.mkdir(parents=True, exist_ok=True)
            
            with open(output_path, 'w', encoding='utf-8') as f:
                json.dump(card_data, f, indent=2, ensure_ascii=False)
            
            click.echo(f"Agent card saved to {output_path}")
        else:
            click.echo(json.dumps(card_data, indent=2, ensure_ascii=False))
            
    except Exception as e:
        click.echo(f"Error generating agent card: {e}", err=True)
        raise click.Abort()


@click.command("serve")
@click.option("--port", default=8080, help="Server port")
@click.option("--host", default="0.0.0.0", help="Server host")
@click.option("--agent-card", type=click.Path(exists=True), help="AgentCard JSON file")
def serve_command(port: int, host: str, agent_card: Optional[str]) -> None:
    """Serve discovery endpoints (.well-known)."""
    if not agent_card:
        click.echo("Error: --agent-card is required", err=True)
        raise click.Abort()
        
    if not os.path.exists(agent_card):
        click.echo(f"Error: Agent card file '{agent_card}' not found", err=True)
        raise click.Abort()
    
    try:
        # Load agent card data
        with open(agent_card, 'r', encoding='utf-8') as f:
            card_data = json.load(f)
            
        # Import and start discovery server (assumes this exists in the discovery module)
        from contextcore.discovery.server import start_discovery_server
        
        click.echo(f"Starting discovery server on {host}:{port}")
        click.echo(f"Using agent card: {agent_card}")
        
        start_discovery_server(card_data, host=host, port=port)
        
    except FileNotFoundError:
        click.echo(f"Error: Agent card file '{agent_card}' not found", err=True)
        raise click.Abort()
    except json.JSONDecodeError as e:
        click.echo(f"Error parsing agent card JSON: {e}", err=True)
        raise click.Abort()
    except ImportError:
        click.echo("Error: Discovery server not available", err=True)
        raise click.Abort()
    except OSError as e:
        click.echo(f"Error starting server: {e}", err=True)
        raise click.Abort()
    except Exception as e:
        click.echo(f"Unexpected error: {e}", err=True)
        raise click.Abort()


@click.command("fetch")
@click.option("--url", required=True, help="Remote agent base URL")
@click.option("--output", "-o", type=click.Path(), help="Output file path")
def fetch_command(url: str, output: Optional[str]) -> None:
    """Fetch AgentCard from remote agent."""
    try:
        client = DiscoveryClient()
        
        click.echo(f"Fetching agent card from {url}")
        agent_card = client.fetch_agent_card(url)
        
        if output:
            output_path = Path(output)
            output_path.parent.mkdir(parents=True, exist_ok=True)
            
            with open(output_path, 'w', encoding='utf-8') as f:
                json.dump(agent_card, f, indent=2, ensure_ascii=False)
            
            click.echo(f"Agent card saved to {output_path}")
        else:
            click.echo(json.dumps(agent_card, indent=2, ensure_ascii=False))
            
    except Exception as e:
        click.echo(f"Error fetching agent card: {e}", err=True)
        raise click.Abort()


@click.command("list")
@click.option("--tempo-url", default="http://localhost:3200", help="Tempo URL")
@click.option("--time-range", default="24h", help="Time range to search")
def list_command(tempo_url: str, time_range: str) -> None:
    """List agents discovered from Tempo."""
    try:
        client = DiscoveryClient()
        
        click.echo(f"Querying Tempo at {tempo_url} for agents in last {time_range}")
        agents = client.list_agents_from_tempo(tempo_url, time_range)
        
        if not agents:
            click.echo("No agents found")
            return
            
        click.echo(f"Found {len(agents)} agent(s):")
        click.echo(json.dumps(agents, indent=2, ensure_ascii=False))
        
    except Exception as e:
        click.echo(f"Error listing agents from Tempo: {e}", err=True)
        raise click.Abort()


# Register commands with the group
discovery_group.add_command(card_command)
discovery_group.add_command(serve_command) 
discovery_group.add_command(fetch_command)
discovery_group.add_command(list_command)
